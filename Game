import React, { useState, useEffect } from "react";
import { base44 } from "@/api/base44Client";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Progress } from "@/components/ui/progress";
import { DollarSign, Flame, Zap, Trophy, AlertCircle, Clock, Menu, ShoppingCart } from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Sheet, SheetContent, SheetHeader, SheetTitle, SheetTrigger } from "@/components/ui/sheet";
import { useNavigate } from "react-router-dom";
import { createPageUrl } from "@/utils";
import ShopPanel from "../components/game/ShopPanel";

export default function GamePage() {
  const queryClient = useQueryClient();
  const navigate = useNavigate();
  const urlParams = new URLSearchParams(window.location.search);
  const roomId = urlParams.get('room_id');
  
  const [currentQuestion, setCurrentQuestion] = useState(null);
  const [selectedAnswer, setSelectedAnswer] = useState(null);
  const [showResult, setShowResult] = useState(false);
  const [isCorrect, setIsCorrect] = useState(false);
  const [timeLeft, setTimeLeft] = useState(600);
  const [gameEnded, setGameEnded] = useState(false);
  const [showShop, setShowShop] = useState(false);
  const audioRef = React.useRef(null);
  const correctAudioRef = React.useRef(null);
  const incorrectAudioRef = React.useRef(null);

  const { data: user } = useQuery({
    queryKey: ['user'],
    queryFn: () => base44.auth.me(),
  });

  const { data: questions } = useQuery({
    queryKey: ['questions'],
    queryFn: () => base44.entities.Question.list(),
    initialData: [],
  });

  const { data: rooms } = useQuery({
    queryKey: ['room', roomId],
    queryFn: () => base44.entities.Room.filter({ id: roomId }),
    enabled: !!roomId,
    initialData: [],
    refetchInterval: 2000,
  });

  const room = rooms[0];

  const { data: players } = useQuery({
    queryKey: ['room-players', roomId],
    queryFn: () => base44.entities.RoomPlayer.filter({ room_id: roomId }),
    enabled: !!roomId,
    initialData: [],
    refetchInterval: 2000,
  });

  const myPlayer = players.find(p => p.player_email === user?.email);
  const sortedPlayers = [...players].sort((a, b) => b.current_money - a.current_money);

  const { data: upgrades } = useQuery({
    queryKey: ['class-upgrades', room?.class_id],
    queryFn: () => base44.entities.Upgrade.filter({ class_id: room.class_id }),
    enabled: !!room?.class_id,
    initialData: [],
  });

  const { data: studentUpgrades } = useQuery({
    queryKey: ['student-upgrades', roomId, user?.email],
    queryFn: () => base44.entities.StudentUpgrade.filter({ 
      room_id: roomId,
      student_email: user.email 
    }),
    enabled: !!roomId && !!user,
    initialData: [],
  });

  const { data: audioSettings } = useQuery({
    queryKey: ['audio-settings'],
    queryFn: () => base44.entities.AppSettings.filter({ setting_category: "music" }),
    initialData: [],
  });

  const gameMode = room?.game_mode || 'classic';
  const musicUrl = audioSettings.find(s => s.setting_name === `${gameMode}_music`)?.setting_value;
  const correctAudioUrl = audioSettings.find(s => s.setting_name === 'correct_audio')?.setting_value;
  const incorrectAudioUrl = audioSettings.find(s => s.setting_name === 'incorrect_audio')?.setting_value;

  const updatePlayerMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.RoomPlayer.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['room-players'] });
    },
  });

  const updateRoomMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.Room.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['room'] });
    },
  });

  const createStudentUpgradeMutation = useMutation({
    mutationFn: (data) => base44.entities.StudentUpgrade.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['student-upgrades'] });
    },
  });

  const updateStudentUpgradeMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.StudentUpgrade.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['student-upgrades'] });
    },
  });

  useEffect(() => {
    if (!room?.started_at || gameEnded) return;

    const interval = setInterval(() => {
      const elapsed = Math.floor((Date.now() - new Date(room.started_at).getTime()) / 1000);
      const remaining = (room.game_duration_minutes * 60) - elapsed;
      
      if (remaining <= 0) {
        setTimeLeft(0);
        setGameEnded(true);
        if (room.status !== 'finished') {
          updateRoomMutation.mutate({
            id: room.id,
            data: { status: 'finished' }
          });
        }
      } else {
        setTimeLeft(remaining);
      }
    }, 1000);

    return () => clearInterval(interval);
  }, [room, gameEnded]);

  useEffect(() => {
    if (questions.length > 0 && !showResult && !gameEnded) {
      const randomQuestion = questions[Math.floor(Math.random() * questions.length)];
      setCurrentQuestion(randomQuestion);
    }
  }, [questions, showResult, gameEnded]);

  useEffect(() => {
    if (audioRef.current && musicUrl) {
      audioRef.current.volume = 0.3;
      audioRef.current.loop = true;
      const playPromise = audioRef.current.play();
      
      if (playPromise !== undefined) {
        playPromise.catch(err => {
          const playOnInteraction = () => {
            audioRef.current.play().catch(e => console.log("Music play failed:", e));
            document.removeEventListener('click', playOnInteraction);
          };
          document.addEventListener('click', playOnInteraction);
        });
      }
    }
  }, [musicUrl]);

  const playSound = (url, ref) => {
    if (ref.current && url) {
      ref.current.volume = 0.5;
      ref.current.play().catch(e => console.log("Sound play failed:", e));
    }
  };

  const getUpgradeBonus = (effectType) => {
    return studentUpgrades
      .filter(su => {
        const upgrade = upgrades.find(u => u.id === su.upgrade_id);
        return upgrade?.effect_type === effectType;
      })
      .reduce((sum, su) => {
        const upgrade = upgrades.find(u => u.id === su.upgrade_id);
        return sum + (upgrade?.effect_value || 0) * su.level;
      }, 0);
  };

  const handlePurchaseUpgrade = (upgrade, newLevel) => {
    if (myPlayer.current_money < upgrade.cost) return;

    const existingUpgrade = studentUpgrades.find(su => su.upgrade_id === upgrade.id);

    // Deduct cost
    updatePlayerMutation.mutate({
      id: myPlayer.id,
      data: {
        current_money: myPlayer.current_money - upgrade.cost,
      }
    });

    if (existingUpgrade) {
      updateStudentUpgradeMutation.mutate({
        id: existingUpgrade.id,
        data: { level: newLevel }
      });
    } else {
      createStudentUpgradeMutation.mutate({
        student_email: user.email,
        upgrade_id: upgrade.id,
        room_id: roomId,
        level: newLevel,
      });
    }
  };

  const handleAnswerClick = (answerNum) => {
    if (showResult || gameEnded) return;
    
    setSelectedAnswer(answerNum);
    const correct = answerNum === currentQuestion.correct_answer;
    setIsCorrect(correct);
    setShowResult(true);

    if (correct) {
      playSound(correctAudioUrl, correctAudioRef);
    } else {
      playSound(incorrectAudioUrl, incorrectAudioRef);
    }

    if (myPlayer) {
      const multiplierBonus = 1 + getUpgradeBonus('multiplier');
      const moneyBonus = getUpgradeBonus('money_boost');
      const baseEarning = 100 + moneyBonus;
      const streakMultiplier = correct ? (1 + myPlayer.current_streak * 0.1) : 1;
      const moneyEarned = correct ? Math.floor(baseEarning * multiplierBonus * streakMultiplier) : 0;

      const newStreak = correct ? myPlayer.current_streak + 1 : 0;

      updatePlayerMutation.mutate({
        id: myPlayer.id,
        data: {
          current_money: myPlayer.current_money + moneyEarned,
          current_streak: newStreak,
          questions_answered: myPlayer.questions_answered + 1,
          correct_answers: myPlayer.correct_answers + (correct ? 1 : 0),
        }
      });
    }

    setTimeout(() => {
      setShowResult(false);
      setSelectedAnswer(null);
    }, 2000);
  };

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  const leaveLobby = () => {
    if (user.user_role === 'teacher') {
      navigate(createPageUrl("TeacherDashboard"));
    } else {
      navigate(createPageUrl("StudentDashboard"));
    }
  };

  if (!myPlayer || !room) {
    return (
      <div className="min-h-screen flex items-center justify-center p-4">
        <Card className="bg-white/80 backdrop-blur-sm border-emerald-200 p-8">
          <CardContent className="text-center">
            <Zap className="w-16 h-16 text-emerald-500 mx-auto mb-4 animate-pulse" />
            <p className="text-xl text-gray-700">Loading game...</p>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (gameEnded) {
    const winner = sortedPlayers[0];

    return (
      <div className="min-h-screen flex items-center justify-center p-4">
        {musicUrl && <audio ref={audioRef} src={musicUrl} />}
        
        <Card className="bg-white/90 backdrop-blur-sm border-2 border-emerald-200 shadow-2xl max-w-2xl w-full">
          <CardContent className="p-12 text-center">
            <Trophy className="w-24 h-24 text-amber-500 mx-auto mb-6" />
            <h1 className="text-4xl font-bold text-gray-800 mb-4">Game Over!</h1>
            
            <div className="mb-8">
              <p className="text-xl text-gray-600 mb-2">Winner</p>
              <p className="text-3xl font-bold text-emerald-700 mb-1">{winner?.player_name}</p>
              <p className="text-2xl text-emerald-600">${winner?.current_money}</p>
            </div>

            <div className="space-y-3 mb-8">
              {sortedPlayers.slice(0, 5).map((player, index) => (
                <div key={player.id} className="flex items-center justify-between p-4 bg-emerald-50 rounded-lg">
                  <div className="flex items-center gap-3">
                    <span className="text-2xl font-bold text-gray-600">#{index + 1}</span>
                    <span className="font-semibold text-gray-800">{player.player_name}</span>
                  </div>
                  <span className="text-xl font-bold text-emerald-600">${player.current_money}</span>
                </div>
              ))}
            </div>

            <Button
              onClick={leaveLobby}
              className="w-full bg-gradient-to-r from-emerald-500 to-teal-500 text-white py-6 text-lg"
            >
              Back to Dashboard
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (!currentQuestion) return null;

  const answers = [
    { num: 1, text: currentQuestion.answer_1 },
    { num: 2, text: currentQuestion.answer_2 },
    { num: 3, text: currentQuestion.answer_3 },
    { num: 4, text: currentQuestion.answer_4 },
  ].filter(a => a.text);

  return (
    <div className="min-h-screen p-4 md:p-8">
      {musicUrl && <audio ref={audioRef} src={musicUrl} />}
      {correctAudioUrl && <audio ref={correctAudioRef} src={correctAudioUrl} />}
      {incorrectAudioUrl && <audio ref={incorrectAudioRef} src={incorrectAudioUrl} />}
      
      <div className="max-w-4xl mx-auto">
        <div className="grid grid-cols-5 gap-4 mb-8">
          <Card className={`border-none shadow-lg ${timeLeft <= 60 ? 'bg-gradient-to-br from-red-500 to-orange-500 animate-pulse' : 'bg-gradient-to-br from-purple-500 to-pink-500'}`}>
            <CardContent className="p-4">
              <div className="flex items-center justify-between text-white">
                <Clock className="w-5 h-5" />
                <span className="text-2xl font-bold">{formatTime(timeLeft)}</span>
              </div>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-br from-emerald-500 to-teal-500 border-none shadow-lg">
            <CardContent className="p-4">
              <div className="flex items-center justify-between text-white">
                <DollarSign className="w-5 h-5" />
                <span className="text-2xl font-bold">${myPlayer.current_money}</span>
              </div>
            </CardContent>
          </Card>

          <Card className="bg-gradient-to-br from-orange-500 to-red-500 border-none shadow-lg">
            <CardContent className="p-4">
              <div className="flex items-center justify-between text-white">
                <Flame className="w-5 h-5" />
                <span className="text-2xl font-bold">{myPlayer.current_streak}</span>
              </div>
            </CardContent>
          </Card>

          <Sheet open={showShop} onOpenChange={setShowShop}>
            <SheetTrigger asChild>
              <Card className="bg-gradient-to-br from-purple-500 to-pink-500 border-none shadow-lg cursor-pointer hover:scale-105 transition-transform">
                <CardContent className="p-4">
                  <div className="flex items-center justify-between text-white">
                    <ShoppingCart className="w-5 h-5" />
                    <Zap className="w-5 h-5" />
                  </div>
                </CardContent>
              </Card>
            </SheetTrigger>
            <SheetContent className="w-96 overflow-y-auto">
              <SheetHeader>
                <SheetTitle className="text-2xl mb-4">Upgrade Shop</SheetTitle>
              </SheetHeader>
              <ShopPanel 
                upgrades={upgrades}
                myPlayer={myPlayer}
                onPurchase={handlePurchaseUpgrade}
                studentUpgrades={studentUpgrades}
              />
            </SheetContent>
          </Sheet>

          <Sheet>
            <SheetTrigger asChild>
              <Card className="bg-gradient-to-br from-cyan-500 to-blue-500 border-none shadow-lg cursor-pointer hover:scale-105 transition-transform">
                <CardContent className="p-4">
                  <div className="flex items-center justify-between text-white">
                    <Trophy className="w-5 h-5" />
                    <Menu className="w-5 h-5" />
                  </div>
                </CardContent>
              </Card>
            </SheetTrigger>
            <SheetContent className="w-96">
              <SheetHeader>
                <SheetTitle className="text-2xl mb-4">Live Leaderboard</SheetTitle>
              </SheetHeader>
              <div className="space-y-3">
                {sortedPlayers.map((player, index) => (
                  <Card key={player.id} className={`${player.player_email === user.email ? 'bg-emerald-100 border-emerald-400' : 'bg-white'} border`}>
                    <CardContent className="p-4">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <span className="text-xl font-bold text-gray-600">#{index + 1}</span>
                          <div>
                            <p className="font-semibold text-gray-800">{player.player_name}</p>
                            <p className="text-xs text-gray-500">
                              {player.correct_answers}/{player.questions_answered} correct
                            </p>
                          </div>
                        </div>
                        <span className="text-lg font-bold text-emerald-600">${player.current_money}</span>
                      </div>
                    </CardContent>
                  </Card>
                ))}
              </div>
            </SheetContent>
          </Sheet>
        </div>

        <div className="mb-6">
          <div className="flex justify-between items-center mb-2">
            <span className="text-sm text-gray-600">Question {myPlayer.questions_answered + 1}</span>
            <span className="text-sm text-gray-600">{myPlayer.correct_answers} / {myPlayer.questions_answered} Correct</span>
          </div>
          <Progress 
            value={(myPlayer.correct_answers / Math.max(myPlayer.questions_answered, 1)) * 100} 
            className="h-2 bg-gray-200"
          />
        </div>

        <AnimatePresence mode="wait">
          <motion.div
            key={currentQuestion.id}
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -20 }}
            transition={{ duration: 0.3 }}
          >
            <Card className="bg-white/90 backdrop-blur-sm border-2 border-emerald-200 shadow-2xl mb-6">
              <CardContent className="p-8 md:p-12">
                <h2 className="text-2xl md:text-3xl font-bold text-gray-800 text-center mb-8">
                  {currentQuestion.question_text}
                </h2>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {answers.map((answer) => {
                    const isSelected = selectedAnswer === answer.num;
                    const isCorrectAnswer = answer.num === currentQuestion.correct_answer;
                    
                    let buttonClass = "bg-white hover:bg-emerald-50 border-2 border-gray-200 hover:border-emerald-400 text-gray-800";
                    
                    if (showResult && isSelected) {
                      buttonClass = isCorrect 
                        ? "bg-emerald-500 border-emerald-600 text-gray-900 font-bold" 
                        : "bg-red-500 border-red-600 text-gray-900 font-bold";
                    } else if (showResult && isCorrectAnswer && !isCorrect) {
                      buttonClass = "bg-emerald-500 border-emerald-600 text-gray-900 font-bold";
                    }

                    return (
                      <Button
                        key={answer.num}
                        onClick={() => handleAnswerClick(answer.num)}
                        disabled={showResult}
                        className={`${buttonClass} h-auto py-6 px-6 text-lg font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105`}
                      >
                        {answer.text}
                      </Button>
                    );
                  })}
                </div>

                {showResult && (
                  <motion.div
                    initial={{ opacity: 0, scale: 0.8 }}
                    animate={{ opacity: 1, scale: 1 }}
                    className="mt-6"
                  >
                    <Alert className={isCorrect ? "bg-emerald-50 border-emerald-500" : "bg-red-50 border-red-500"}>
                      <AlertDescription className="flex items-center justify-center gap-2 text-lg font-semibold">
                        {isCorrect ? (
                          <>
                            <Zap className="w-5 h-5 text-emerald-600" />
                            <span className="text-emerald-700">Correct! Great job!</span>
                          </>
                        ) : (
                          <>
                            <AlertCircle className="w-5 h-5 text-red-600" />
                            <span className="text-red-700">Incorrect! Streak reset.</span>
                          </>
                        )}
                      </AlertDescription>
                    </Alert>
                  </motion.div>
                )}
              </CardContent>
            </Card>
          </motion.div>
        </AnimatePresence>

        {myPlayer.current_streak >= 3 && (
          <Card className="bg-gradient-to-r from-orange-100 to-red-100 border-orange-300">
            <CardContent className="p-4">
              <div className="flex items-center justify-center gap-2 text-orange-700">
                <Flame className="w-5 h-5" />
                <span className="font-semibold">
                  Streak Bonus Active! +{myPlayer.current_streak * 10}% earnings
                </span>
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  );
}
